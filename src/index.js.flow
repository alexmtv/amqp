// @flow

// General Json type
export type JsonValue = { [key:string]: JsonValue } | Array<JsonValue> | number | string | boolean | null

// Amqp connection
// Incomplete type definition.  Includes only what is currently in use.
export type AmqpConnection = {
  createChannel:() => Promise<AmqpChannel>
}

// Amqp message
export type Message = {
  content: Buffer,
  fields: {},
  properties: {}
}

// AmqpChannel
// Incomplete type definition.  Includes only what is currently in use.
export type AmqpChannel = {
  assertExchange:(exchangeName:string, type:string, options:{}) => Promise<AssertExchangeResponse>,
  assertQueue:(queueName:string) => Promise<AssertQueueResponse>,
  bindQueue:(queueName:string, exchangeName:string, routingKey:string) => Promise<BindQueueResponse>,
  publish:(exchangeName:string, routingKey:string, messageBuffer:Buffer, options:PublishOptions) => boolean,
  consume:(queueName:string, handleMessage:(message:Message)=>any) => Promise<ConsumeResponse>,
  ack:Ack,
  nack:Nack
}

// Amqp Connection Manager
// Managed Connection type
export type AmqpManagedConnection = {
  createChannel:(opts:AmqpManagedChannelOptions) => Promise<AmqpChannel>
}

// Amqp Connection Manager Channel options
export type AmqpManagedChannelOptions = {
  setup: SetupChannel
}

export type Channel = (setup:SetupChannel) => Promise<AmqpChannel>
export type SetupChannel = (chan:AmqpChannel) => Promise<AmqpChannel>
export type AssertChannel = (config:QueueConfig, channel:AmqpChannel) => Promise<AmqpChannel>

// Exchange, queue, and routingKey tuple
export type QueueConfig = {exchangeName:string, queueName:string, routingKey:string}

// Message handler function
export type MessageHandler<R> = (ack:Ack, nack:Nack, message:Message) => Promise<R>

export type MessageParser<T> = (msg: Message) => T
export type MessageResultHandler<T> = (ack:Ack, nack:Nack, message:Message, result:T) => ?Promise<any>
export type MessageContentHandler<C, R> = (content:C) => Promise<R>

// Message publisher
export type Publisher = (message:string) => Promise<boolean>

export type PublishOptions = {}

export type AssertExchangeResponse = {
  exchange: string
}

export type AssertQueueResponse = {
  queue: string,
  messageCount: number,
  consumerCount: number
}

export type BindQueueResponse = {};

export type ConsumeResponse = {
  consumerTag:string
}

export type Ack = (message:Message) => any
export type Nack = (message:Message) => any

// Public API
declare export function createChannel(connection:AmqpConnection|Promise<AmqpConnection>): Channel

declare export function createManagedChannel(connection: AmqpManagedConnection): Channel

declare export function consumeFrom(createChannel:Channel): (config:QueueConfig, messageHandler:MessageHandler) => Promise<{}>

declare export function publishTo(createChannel:Channel): (config:QueueConfig) => Publisher

declare export function parseJsonMessage(encoding: string): MessageParser<JsonValue>

declare export function parseAndHandleMessage<C, R> (
  parseMessage: MessageParser<C>,
  handleFailure: MessageResultHandler<any>,
  handleSuccess: MessageResultHandler<R>,
  handleMessage: MessageContentHandler<C, R>): MessageHandler

declare export function defaultParseAndHandleMessage(handleMessage: MessageContentHandler<JsonValue, any>): MessageHandler
